# 进程管理

关于误触ctrl+z导致进程被挂起，需要回复进程用` fg +  进程序号`

**进程定义：能和其它程序并行执行的程序段在某数据集合上的一次运行过程**

## 一、进程类型

守护进程：在系统引导过程中启动的进程，跟终端无关的进程

前台进程：跟终端相关，通过终端启动的进程



## 二、进程的生命周期

所有进程都可以创建子进程，所有进程都是第一个系统进程(systemd)的子进程



### systemd简介

systmed 是一个用户空间的程序，属于应用程序，不属于 Linux 内核范畴。Systemd 是 Linux 系统中最新的初始化系统（init），它主要的设计目标是克服 sysvinit（这个是centos6中的初始化系统）固有的缺点，提高系统的启动速度。



### systemd unit 类型

systemd需要管理的功能比较多，所以支持的配置单元类型也比较繁多，我们在日常使用Linux的过程中对系统服务的管理最多，所以我们主要了解一下`service`类型即可，其他类型作为一个了解，下面列举出所有类型详细的解释。

| **单元类型**   | **文件格式** | **描述**                                                     |
| :------------- | :----------- | :----------------------------------------------------------- |
| Service unit   | .service     | 服务类                                                       |
| Target unit    | .target      | 一个 unit 服务组，用于模拟实现运行级别                       |
| Automount unit | .automount   | 文件系统自动挂载点                                           |
| Device unit    | .device      | 内核识别的设备文件                                           |
| Mount unit     | .mount       | 文件系统挂载点                                               |
| Path unit      | .path        | 文件或目录                                                   |
| Scope unit     | .scope       | 外部创建的进程                                               |
| Slice unit     | .slice       | A group of hierarchically organized units that manage system processes. |
| Snapshot unit  | .snapshot    | 系统快照                                                     |
| Socket unit    | .socket      | 套接字                                                       |
| Swap unit      | .swap        | 标识 swap 设备                                               |
| Timer unit     | .timer       | systemd 的计时器                                             |

### unit 文件保存位置

我们目前了解到文件所在的位置即可，关于文件内部的格式与如何修改这些文件，我们会在后续的服务搭建过程中细讲。

| **目录**                 | **描述**                          |
| :----------------------- | :-------------------------------- |
| /usr/lib/systemd/system/ | RPM 包安装时分发的 unit 文件      |
| /run/systemd/system/     | systemd 运行时创建的文件          |
| /etc/systemd/system/     | systemctl enable 创建的 unit 文件 |



### systemctl常用命令

| **命令**                                                     | **描述**                     |
| :----------------------------------------------------------- | :--------------------------- |
| systemctl start name.service                                 | 启动服务                     |
| systemctl stop name.service                                  | 停止服务                     |
| systemctl status name.service                                | 检查服务状态                 |
| systemctl enable name.service                                | 启用开机自启服务             |
| systemctl disable name.service                               | 停用自启服务                 |
| systemctl status name.service systemctl is-enabled name.service | 检查服务状态查看服务是否自启 |
| systemctl is-active name.service                             | 检查服务是否启               |



## 三、查看进程状态

### ps

ps命令用于显示当前进程的状态，类似于 windows 的任务管理器

```shell
ps [选项]
```

选项

- **-a**：列出所有的进程
- **-e**：列出所有的进程，等同于`-A`
- **-f**：显示不包含资源使用率的相关信息
- **‐H**：以进程层级格式显示进程相关信息
- **-w**：显示加宽可以显示较多的信息
- **-u**：显示较详细的信息
- **-x**：显示其他使用者的行程

显示信息的格式说明

| **列名** | **说明**           |
| :------- | :----------------- |
| USER     | 进程拥有者         |
| PID      | 进程ID             |
| %CPU     | 占用的 CPU 使用率  |
| %MEM     | 占用的内存使用率   |
| VSZ      | 占用的虚拟内存大小 |
| RSS      | 占用的常驻内存大小 |
| TTY      | 执行的终端编号     |
| STAT     | 该进程的状态       |
| START    | 进程开始时间       |
| TIME     | CPU使用时间        |
| COMMAND  | 所执行的命令       |

status表示状态：

- **D**: 无法中断的休眠状态 ，将一直等待事件的发生或等待某种系统资源

- **R**: 正在执行中

- **S**: 可中断状态

- **T**: 暂停执行

- Z: 不存在但暂时无法消除，也叫僵尸进程

  - 每个进程在运行结束后都会处于僵死状态，等待父进程调用进而释放系统资源，处于该状态的进程已经运行结束，但是它的父进程还没有释放其系统资源
  
  
   孤儿进程:一个父进程退出，而它的一个或多个子进程还在运行，那么这些子进程将成为孤儿进程。
  
- **W**: 没有足够的内存可分配

- **<**: 高优先序的进程

- **N**: 低优先序的进程

- **+**：前台进程

- **l**：多线程进程

- **s**：主进程(先导进程)



#### ps常用命令

ps aux：查看所有进程

```bash
u：以用户为中心组织进程状态信息显示
a：与终端相关的进程；
x：与终端无关的进程
```

ps -ef

```bash
-e：显示所有进程
-f：显示完整格式程序信息
```

ps -efH：以层级格式查看进程



### top

top命令用于实时显示 process 的动态

```bash
top - 17:10:13 up  6:39,  2 users,  load average: 0.00, 0.01, 0.05
Tasks: 125 total,   1 running, 124 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  1863248 total,   748836 free,   166976 used,   947436 buff/cache
KiB Swap:  2097148 total,  2097148 free,        0 used.  1472040 avail Mem
```

第1行：系统时间、运行时间、登录终端数、系统负载（三个数值分别为1分钟、5分钟、15分钟内的平均值，数值越小意味着负载越低）。

第2行：进程总数、运行中的进程数、睡眠中的进程数、停止的进程数、僵死的进程数。

第3行：用户占用资源百分比、系统内核占用资源百分比、改变过优先级的进程资源百分比、空闲的资源 百分比等。

第4行：物理内存总量、内存使用量、内存空闲量、作为内核缓存的内存量。（buffer和cache之间的区 别，cache是提高cpu和内存之间的数据交换速度，buffer是io设备和存储设备之间的缓冲区）

第5行：虚拟内存总量、虚拟内存使用量、虚拟内存空闲量、已被提前加载的内存量。



```shell
top -[选项]
```

选项

- **-d**: 改变显示的更新速度，或是在交互式指令列( interactive command)按 s
- **-c**: 切换显示模式，共有两种模式，一是只显示程序的名称，另一种是显示完整的路径与名称
- **-S**: 累积模式，会将己完成或消失的子行程  的 CPU time 累积起来
- **-s**: 安全模式，将交互式指令取消, 避免潜在的危机
- **-i**: 不显示任何闲置 (idle) 或无用 (zombie) 的行程
- **-n**: 更新的次数，完成后将会退出 top
- **-b**: 显示模式，搭配 "n" 参数一起使用，可以用来将 top 的结果输出到文件内
- **-z：**彩色



交互模式快捷键

| 快捷键 | 功能                                                    |
| :----- | :------------------------------------------------------ |
| 空格   | 立即刷新                                                |
| P      | 根据CPU使用多少排序                                     |
| T      | 根据时间、累计排序                                      |
| q      | 退出top命令                                             |
| m      | 切换显示内存信息                                        |
| t      | 切换显示进程和CPU状态信息                               |
| c      | 切换显示命令名称和完整命令行                            |
| M      | 根据内存的大小排序                                      |
| W      | 将当前设置写入 ~/.toprc 文件中，这是top配置文件推荐方法 |
| N      | 以PID的大小排序                                         |
| z      | 彩色                                                    |



通过端口号查找进程

```bash
Netstat -nlp  | grep duan'kou
-n --numeric 通过数值展示ip地址
-l --listening 只打印正在监听的网络连接
-p --program 打印端口号对应进程的进程号

lsof -i :端口号
或者：lsof -i | grep 端口号
-i --internet 选择网络地址与-i表示的内容匹配的所有文件
```



## 四、结束进程

### kill

kill 命令用于删除执行中的程序或工作。kill 可将指定的信号送至程序。预设的信号为 SIGTERM(15)，可将指定程序终止

```shell
kill [-s <信息名称或编号>][程序]　或　kill [-l <信息编号>]
```

选项

- **-l <信号编号>**： 若不加<信号编号>选项，则 -l 参数会列出全部的信号名称
- **-s <信号名称或编号>**：指定要送出的信息
- **[程序]**：[程序]可以是程序的PID或是PGID

使用 kill -l 命令列出所有可用信号，最常用的信号如下

| **编号** | **信号名** | **作用**                |
| :------- | :--------- | :---------------------- |
| 1        | SIGHUP     | 重新加载配置            |
| 2        | SIGINT     | 键盘中断^C              |
| 3        | SIGQUIT    | 键盘退出                |
| 9        | SIGKILL    | 强制终止                |
| 15       | SIGTERM    | 终止(正常结束),缺省信号 |
| 18       | SIGCONT    | 继续                    |
| 19       | SIGSTOP    | 停止                    |
| 20       | SIGTSTP    | 暂停^Z                  |



### pkill

pkill 用于杀死一个进程，与 kill 不同的是**它会杀死指定名字的所有进程**，类似于 killall 命令

```shell
pkill [选项]  name
```

选项

- **name**： 进程名
- **-u**：指定用户名
- **-t**：指定终端

w命令是一个用于查看当前登录用户和系统负载的命令。它以表格形式呈现登录用户的信息，包括用户名、终端、登录时间、远程主机和当前运行的命令。此外，它还提供系统负载信息，例如平均负载和CPU使用率。

以下是w命令的基本语法：

```bash
w [options]
```

#### 选项

下面列举了w命令的可用选项以及它们的用法：

```bash
-h或--no-header：不显示表头。
-s或--short：使用短格式输出。只显示用户名、终端、远程主机和登录时间信息。
-f或--from：显示远程主机的信息。
-o或--old-style：使用旧式格式输出。不显示用户从哪台主机登录。
-u或--lookup：将数字用户ID转换为用户名。
```



## 五、进程优先级

### 相对优先级nice

进程优先级 0-99：实时优先级，数字越小，优先级越低

-99-39：静态优先级，数字越小，优先级越高

#### 查看优先级

#### ps查看

```bash
[root@localhost ~]# ps axo pid,command,nice --sort=nice     # 按照yo
[root@localhost ~]# ps axo pid,command,nice,cls --sort=-nice
```

#### top查看

NI：实际nice级别

PR：将nice级别显示为映射到更大优先级队列，-20映射到0，+19映射到39



#### PRI

PR值是OS动态调整的，但是PR的最终值还是需要由OS分析决定的



### jobs

jobs 命令可以用来查看当前终端放入后台的任务

```shell
jobs [-lnprs] [任务声明 ...]
```



#### 将任务放入到后台

Linux 命令放入后台的方法有两种：

- 在命令后面加入`空格 &`。使用这种方法放入后台的命令，在后台处于执行状态
- 命令执行过裎中按 Ctrl+Z 快捷键，命令在后台处于暂停状态



#### 将任务恢复到前台

fg 命令用于把后台工作恢复到前台执行

```shell
fg %工作号
```

**注意，在使用此命令时，％ 可以省略，但若将% 工作号全部省略，则此命令会将带有 + 号的工作恢复到前台。另外，使用此命令的过程中， % 可有可无。**



#### 后台任务恢复到后台运行

前面讲过，使用`Ctrl+z`快捷键的方式，可以将前台工作放入后台，但是会处于暂停状态,可以使用bg命令

```shell
bg %工作号
```

这里的 % 可以省略



### nohup

虽然可以将程序放在后台运行，但是一旦关闭远程连接那么程序就会中断，如果我们想要将程序一直保持在后台运行，那么我们可以有如下三个选择：

- 把需要在后台执行的命令加入`/etc/rc.local`文件，让系统在启动时执行这个后台程序。这种方法的问题是，服务器是不能随便重启的，如果有临时后台任务，就不能执行了
- 使用系统定时任务，让系统在指定的时间执行某个后台命令。这样放入后台的命令与终端无关，是不依赖登录终端的
- 使用 nohup 命令

```shell
nohup 命令&
```

注意，这里的‘&’表示此命令会在终端后台工作；反之d，如果没有‘&’，则表示此命令会在终端前台工作。

# 本节重点：

## 1.什么是进程

常用进程命令

systemctl   

start  

stop  

status  

enable

## 2.查看进程

ps 

常用组合

ps aux -aux

ps -ef

ps -efh

top实时查看进程的动态

top

## 3.如何创建或者终止系统中的进程

程序就会被注册成进程，可通过ps或top看到

终止：

​	kill -9

​	kill -15

​	pkill 进程名

## 4.（时间片流转法）如何管理进程优先级

nice：用户可手动调整，-20~19

pr：用户无法调整，0~39

pr（新）=pr（旧）+ nice

管理：

查看 ps axo pid,command,nice

top

管理：

nice -n 优先级数 进程名

renice 优先级数 [进程id]



存储管理

1.如何对一个新的硬盘进行分区

parted  fdisk gdisk

格式化分区：mkfs.ext4 /dev/sdb1



