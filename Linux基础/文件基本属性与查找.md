#  文件基本属性与查找和用户权限管理

## 文件基本属性与查找

### 一、文件时间

#### stat

用于显示文件时间和 inode 内容，inode相关的知识会在后面的磁盘管理章节详细讲解，这边主要来看文件的时间

```bash
stat [选项]... 文件...
```

- Access：访问时间，也叫atime
  - 当文件被访问的时候，这个时间就会发生改变
  - Linux文件运行的时候查看文件又频繁数量又大，如果每次atime发生变化的时候都记入硬盘，或造成很大的压
  - 力。RHEL6开始relatime，atime延迟修改，必须满足其中一个条件：
    - 自上次atime修改后，已达到86400秒
    - 发生写操作时
- Modify：修改时间，也叫mtime
  - 当文件内容发生变化的时候，这个时间就会发生改变
- Change：改变时间，也叫ctime
  - 当文件状态被改变的时候，这个时间就会发生修改



### 二、文件类型

#### 方法一：ls

使用ls可以查看当前目录下有哪些文件，我们会发现文件夹和文件的颜色并不一样，所以我们可以简单的通过颜色来进行判断，不过这种判断的方式并不准确，因为不同的Linux发行套件颜色的标准并不一样，不同的远程管理工具对颜色的理解也有偏差，比如可能把蓝色显示为淡蓝色，而淡蓝色又显示成其他颜色。所以最推荐的做法是通过`ls -l`查看第一个字母：

- **-**普通文件(文本文档，二进制文件，压缩文件，电影，图片。。。)

  **d**目录文件

  **b**块设备文件(块设备)存储设备:硬盘，U盘 /dev/sda,/dev/sda1

  **c**字符设备文件(字符设备):打印机，终端 /dev/tty1,/dev/zero

  **s**套接字文件

  **p**管道文件

  **l**链接文件

```bash
[root@localhost ~]# ls -l -d /etc/hosts /bin/ls /home /dev/sda /dev/tty1 /etc/grub2.cfg /dev/log /run/dmeventd-client 
-rwxr-xr-x. 1 root root 117680 10月 31 2018 /bin/ls
srw-rw-rw-. 1 root root      0 4月   4 16:54 /dev/log
brw-rw----. 1 root disk   8, 0 4月   4 16:54 /dev/sda
crw--w----. 1 root tty    4, 1 4月   4 16:56 /dev/tty1
lrwxrwxrwx. 1 root root     22 4月   4 16:49 /etc/grub2.cfg -> ../boot/grub2/grub.cfg
-rw-r--r--. 1 root root    158 6月   7 2013 /etc/hosts
drwxr-xr-x. 2 root root      6 4月  11 2018 /home
prw-------. 1 root root      0 4月   4 16:54 /run/dmeventd-client
```



#### 方法二：file

file是专门用来查看文件的类型的命令，有时候也可以使用

```bash
[root@localhost ~]# file /etc/hosts
/etc/hosts: ASCII text
[root@localhost ~]# file /bin/ls
/bin/ls: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=ceaf496f3aec08afced234f4f36330d3d13a657b, stripped
[root@localhost ~]# file /dev/sda
/dev/sda: block special
[root@localhost ~]# file /dev/tty1
/dev/tty1: character special
[root@localhost ~]# file /etc/grub2.cfg 
/etc/grub2.cfg: symbolic link to `../boot/grub2/grub.cfg'
```

#### 方法三：stat



### 三、文件查找

#### which

用于查找文件

which指令会在环境变量`$PATH`设置的目录里查找符合条件的文件

```bash
which [文件...]
```



#### locate

locate需要安装

用于查找符合条件的文件，他会去保存文件和目录名称的数据库内，查找合乎范本样式条件的文件或目录

locate的使用方式如下

```bash
locate [选项]... [范本样式]...
```

在使用locate之前，需要更新一下数据库，因为locate只会在数据库中查找文件所在的位置，所以locate查找速度极快，缺点就是数据库更新并不是实时的，更新数据库有两种方式：

- 手动更新，输入`updatedb`
- 默认情况下，`updatedb`会每天自动执行一次

选项

- **-c**：只输出找到的数量
- **-n**：至多显示 n个输出
- **-i**：忽略大小写
- **-r**：使用基本正则表达式
- **--regex**：使用扩展正则表达式
- **-d DBPATH**：使用 DBPATH 指定的数据库，而不是默认数据库 /var/lib/mlocate/mlocate.db

- 查找passwd文件所在的位置

```bash
[root@localhost ~]# updatedb
# 更新数据库并不是每次查找都需要，但是建议更新数据库来保证数据是最新的
[root@localhost ~]# locate passwd
```



#### find

实时查找工具，通过遍历指定路径下的文件系统完成文件查找

工作特点:

- 查找速度略慢
- 精确查找
- 实时查找
- 可以满足多种条件匹配

```bash
find [选项] [路径] [查找条件 + 处理动作]
查找路径：指定具体目录路径，默认是当前文件夹
查找条件：指定的查找标准（文件名/大小/类型/权限等），默认是找出所有文件
处理动作：对符合条件的文件做什么操作，默认输出屏幕
根据文件名查找：
    ‐name "filename" 支持global
    ‐iname "filename" 忽略大小写
    ‐regex "PATTERN" 以Pattern匹配整个文件路径字符串，而不仅仅是文件名称
根据属主和属组查找：
    ‐user USERNAME：查找属主为指定用户的文件
    ‐group GROUPNAME：查找属组为指定属组的文件
    ‐uid UserID：查找属主为指定的ID号的文件
    ‐gid GroupID：查找属组为指定的GID号的文件
    ‐nouser：查找没有属主的文件
    ‐nogroup：查找没有属组的文件
根据文件类型查找：
    ‐type Type：
    f/d/l/s/b/c/p
根据文件大小来查找：
    ‐size [+|‐]N[bcwkMG]
根据时间戳:
    天：
        ‐atime [+|‐]N
        ‐mtime
        ‐ctime
    分钟：
        ‐amin N
        ‐cmin N
        ‐mmin N
根据权限查找：
    ‐perm [+|‐]MODE
    MODE：精确权限匹配
    /MODE：任何一类(u，g，o)对象的权限中只要能一位匹配即可
    ‐MODE：每一类对象都必须同时拥有为其指定的权限标准
组合条件：
    与：‐a 多个条件and并列
    或：‐o 多个条件or并列
    非：‐not 条件取反
```

查找条件

- 根据文件名查找

```bash
[root@localhost ~]# find /etc -name "ifcfg-ens33"
[root@localhost ~]# find /etc -iname "ifcfg-ens33"    # 忽略大小写
[root@localhost ~]# find /etc -iname "ifcfg*"
```

- 按文件大小

```bash
[root@localhost ~]# find /etc -size +5M    # 大于5M
[root@localhost ~]# find /etc -size 5M    # 等于5M
[root@localhost ~]# find /etc -size -5M    # 小于5M
[root@localhost ~]# find /etc -size +5M -ls    # 找到的处理动作-ls
```

- 指定查找的目录深度

```bash
[root@localhost ~]# find / -maxdepth 3 -a -name "ifcfg-ens33"    # 最大查找深度
# -a是同时满足，-o是或
[root@localhost ~]# find / -mindepth 3 -a -name "ifcfg-ens33"    # 最小查找深度
```

- 按时间找

```bash
[root@localhost ~]# find /etc -mtime +5        # 修改时间超过5天
[root@localhost ~]# find /etc -mtime 5        # 修改时间等于5天
[root@localhost ~]# find /etc -mtime -5        # 修改时间5天以内
```

- 按照文件属主、属组找，文件的属主和属组，会在下一篇详细讲解。

```bash
[root@localhost ~]# find /home -user xwz    # 属主是xwz的文件
[root@localhost ~]# find /home -group xwz
[root@localhost ~]# find /home -user xwz -group xwz
[root@localhost ~]# find /home -nouser        # 没有属主的文件
[root@localhost ~]# find /home -nogroup        # 没有属组的文件
```

- 按文件类型

```bash
[root@localhost ~]# find /dev -type d
```

- 按文件权限，文件权限会在下一篇详细讲解

```bash
[root@localhost ~]# find / -perm 644 -ls
[root@localhost ~]# find / -perm -644 -ls    # 权限小于644的
[root@localhost ~]# find / -perm 4000 -ls
[root@localhost ~]# find / -perm -4000 -ls
```

- 按正则表达式

```bash
[root@localhost ~]# find /etc -regex '.*ifcfg-ens[0-9][0-9]'
# .*    任意多个字符
# [0-9]    任意一个数字
```



处理动作

- **‐print**：默认的处理动作，显示至屏幕
- **‐ls**：类型于对查找到的文件执行`ls ‐l`命令
- **‐delete**：删除查找到的文件
- **‐fls /path/to/somefile**：查找到的所有文件的长格式信息保存至指定文件中
- **‐ok COMMAND {}\**：对查找到的每个文件执行由COMMAND指定的命令，需要确认
- **‐exec COMMAND {} \**：对查找到的每个文件执行由COMMAND指定的命令，不需要确认
- **{}**：用于引用查找到的文件名称自身

**注意**：在加上处理动作的情况下，命令结束需要加上 `\;` 作为结尾

```bash
[root@localhost ~]# find /usr ‐not \( ‐user root ‐o ‐user bin ‐o ‐user hadoop \) \\组合的情况下，左括号后和右括号\前必须加空格
```



## 用户权限管理

### 一、用户和用户组查看

#### id

用于显示用户的ID，以及所属群组的ID

id会显示用户以及所属群组的实际与有效ID。若两个ID相同，则仅显示实际ID。若仅指定用户名称，则显示目前用户的ID。

```shell
id [OPTION]... [USER]
```

- **-g**：显示用户所属群组的ID。

- **-G**：显示用户所属附加群组的ID。

- **-n**：显示用户，所属群组或附加群组的名称。

- **-r**：显示实际用户ID。

- **-u**：显示有效用户ID。



#### 扩展

passwd文件

用于保存用户的信息，一般第一行是root用户，下面都是其他用户

```shell
[root@localhost ~]# head -n 1 /etc/passwd
root:x:0:0:root:/root:/bin/bash
# 这个格式为用户名:密码:uid:gid:描述:家目录:登陆后执行的命令
```



shadow文件

格式中密码占位置太长了，所以使用x来替代，Linux系统会到shadow中查找x部分的的密码内容

```shell
[root@localhost ~]# head -n 1 /etc/shadow
root:$6$frokclXSnQa8EbKs$pWElbjPlmxjYh30tr8qLsTQVOhuPg7GmW9Sanm2yXAK8TNMgje1gyc/vwPgqvmSMf6VaoEvveM0gFvtETmXy/.::0:99999:7:::
# 这个格式为用户名：加密密码：最后一次修改时间：最小修改时间间隔：密码有效期：密码需要变更前的警告天数：密码过期后的宽限时间：账号失效时间：保留字段
```



#### group文件

用户和组的对应关系，会保存在group文件中

```shell
[root@localhost ~]# head -n 1 /etc/group
root:x:0:
# 这个格式是组名:口令:组标识号:组内用户列表
```



### 二、用户组管理

#### 添加用户组：groupadd

groupadd 命令用于创建一个新的工作组，新工作组的信息将被添加到系统文件中

```shell
groupadd [选项] 组
```



选项

- **-g**：指定新建工作组的 id；

- **-r**：创建系统工作组，系统工作组的组ID小于 500；

- **-K**：覆盖配置文件`/etc/login.defs`

- **-o**：允许添加组 ID 号不唯一的工作组。

- **-f**：如果指定的组已经存在，此选项将失效了仅以成功状态退出。当与 -g 一起使用，并且指定的GID_MIN已经存在时，选择另一个唯一的GID（即-g关闭）。




#### 修改用户组：groupmod

groupmod命令用于更改群组识别码或名称

```shell
groupmod [选项] 组
```

选项

- **-g** GID：将组 ID 改为 GID
- **-n** NEW_GROUP：改名为 NEW_GROUP
- **-o**：允许使用重复的 GID



#### 删除用户组：groupdel

groupdel命令用于删除群组

需要从系统上删除群组时，可用groupdel(group delete)指令来完成这项工作。倘若该群组中仍包括某些用户，则**必须先删除这些用户后**，方能删除群组。

```shell
groupdel [组名]
```



#### 用户组成员管理：gpasswd

gpasswd 是 Linux 下工作组文件 /etc/group 和 /etc/gshadow 管理工具，用于将一个用户添加到组或者从组中删除

```shell
gpasswd [选项] 组
```

选项

- **-a**：添加用户到组；
- **-d**：从组删除用户；
- **-A**：指定管理员；
- **-M**：替换组中的全部用户列表，不包含在内的用户将会从组中删除；
- **-R**：限制用户登入组，只有组中的成员才可以用newgrp加入该组。
- **-r**：删除组的密码
- 默认选项是给组设置密码



### 三、用户管理

#### 添加用户：useradd

useradd可以用来添加新的用户账号

```shell
useradd [选项] 用户名
```

选项

- **-c comment**：指定一段注释性描述。
- **-d 目录**：指定用户主目录，如果此目录不存在，则同时使用-m选项，可以创建主目录。
- **-m**：创建用户的主目录
- **-g 用户组**：指定用户所属的用户组，默认会创建一个和用户名同名的用户组。
- **-G 用户组**：用户组 指定用户所属的附加组，一个用户可以属于多个附加组。
- **-s Shell文件**：指定用户的登录Shell。
- **-u 用户号**：指定用户的用户号，如果同时有-o选项，则可以重复使用其他用户的标识号。



例子：

- 添加一般用户

```shell
[root@localhost ~]# useradd user01
```

- 为添加的用户指定相应的用户组

```shell
[root@localhost ~]# useradd -g root user02
```

- 为新添加的用户指定home目录

```shell
[root@localhost ~]# useradd -d /home/test user03
```

- 建立一个不给登录的用户

```shell
[root@localhost ~]# useradd -s /sbin/nologin user04
```

- 查看用户描述信息

```bash
[root@localhost ~]# cat /etc/passwd |grep user02
user02:x:1004:1004:this is nginx user:/home/user02:/bin/bash
```



#### 切换用户：su

su命令用户Linux系统中的用户切换

用法：

```BASH
su [选项] 用户名
```

常用选项：

- `- 用户名`：以目标用户的环境变量启动新会话。这将模拟用户完全登录到新用户账户，包括其家目录、环境变量等。
- `-c 命令`：执行指定的命令，并在执行完毕后返回原始用户。
- `-s shell`：使用指定的 shell 替代目标用户的默认 shell。



#### 修改用户：usermod

usermod可用来修改用户帐号的各项设定

```shell
usermod [选项] 登录
```

选项

- **-c<备注>**：修改用户帐号的备注文字。
- **-a**：追加，默认的修改是覆盖
- **-d登入目录>**：修改用户登入时的目录。
- **-m** 移动内容：移动登入目录的内容，通常和`-d`一起使用
- **-e<有效期限>**：修改帐号的有效期限。
- **-f<缓冲天数>**：修改在密码过期后多少天即关闭该帐号。
- **-g <组名或GID> <用户名>**：修改用户所属的群组。
- **-G <组名或GID> <用户名>**：修改用户所属的附加群组。
- **-l new old**：修改用户帐号名称。
- **-L**：锁定用户密码，使密码无效。
- **-s**：修改用户登入后所使用的shell。
- **-u**：修改用户ID。
- **-U**：解除密码锁定。



#### 删除用户：userdel

userdel命令用于删除用户帐号

userdel可删除用户帐号与相关的文件。若不加参数，则仅删除用户帐号，而不删除相关文件

```shell
userdel [-r][用户帐号]
```

选项

- **-r**：删除用户登入目录以及目录中所有文件



### 四、passwd文件中的shell

查看`/etc/passwd`文件会发现在每行的最后是登录成功之后执行的命令，有两种是使用最为频繁的：

- /bin/bash：这个是Linux的命令行工具，我们正常登陆之后默认就是进入命令行
- /sbin/nologin：如果写成nologin，那么用户将无法登录，有些用户是作为进程权限管理而存在的，不需要登录。如果提供登录的功能反而不安全，所以写成nologin



### 五、用户密码管理

root用户可以直接设置普通用户密码，普通用户必须要提供原密码，才可以修改自己密码。普通用户在修改密码时，是调用了root用户的权限

#### passwd

passwd命令用来更改使用者的密码

```shell
passwd [选项...] <帐号名称>
```

选项

- **-k**：保持身份验证令牌不过期
- **-d**：删除已命名帐号的密码(仅限 root 用户)
- **-l**：锁定指名帐户的密码(仅限 root 用户)
- **-u**：解锁指名账户的密码(仅限 root 用户)
- **-x**：密码的最长有效时限(仅限 root 用户)
- **-n**：密码的最短有效时限(仅限 root 用户)
- **-w**：在密码过期前多少天开始提醒用户(仅限 root 用户)
- **-i**：当密码过期后经过多少天该帐号会被禁用(仅限 root 用户)
- **-S**：报告已命名帐号的密码状态(仅限 root 用户)
- **--stdin**：从标准输入读取令牌(仅限 root 用户)



- 使用管道符设置用户密码(使用较多)

```shell
[root@localhost ~]# echo 123456 | passwd --stdin test01
```



#### login.defs文件

`/etc/login.defs`文件是用来创建用户时进行一定的限制，但是优先级低于`/etc/passwd`和`/etc/shadow`,如果有冲突的地方,系统会以`/etc/passwd`和`/etc/shadow`为准

例如：

```shell
[root@localhost ~]# egrep -v '^[ ]*$|^#' /etc/login.defs  
MAIL_DIR    /var/spool/mail  # 系统消息(邮件)文件夹
PASS_MAX_DAYS    99999        # 密码有效最大天数 
PASS_MIN_DAYS    0            # 密码有效最小天数
```



#### chage

chage是用于更改用户密码过期信息

```shell
chage [选项] 用户名
```

选项

- **-d**：将最近一次密码设置时间设为“最近日期”
- **-E 过期日期**：将帐户过期时间设为“过期日期”
- **-I INACITVE**：设置密码过期多少天后后，将密码设定为失效状态
- **-l**：显示帐户时间信息
- **-m 最小天数**：设置两次改变密码之间相距的最小天数
- **-M 最大天数**：设置将两次改变密码之间相距的最大天数
- **-W 警告天数**：设置密码过期前的警告天数



#### sudoers

Linux是多用户多任务的操作系统, 共享该系统的用户往往不只一个。出于安全性考虑, 有必要通过useradd创建一些非root用户, 只让它们拥有不完全的权限; 如有必要，再来提升权限执行。

sudo就是来解决这个需求的: 这些非root用户不需要知道root的密码，就可以提权到root，执行一些root才能执行的命令。

```shell
sudo [选项] [用户名] [命令]
```



##### 赋予用户sudo操作的权限

通过useradd添加的用户，并不具备sudo权限。在ubuntu/centos等系统下, 需要将用户加入admin组或者wheel组或者sudo组。以root用户身份执行如下命令, 将用户加入wheel/admin/sudo组。

```shell
usermod -a -G wheel <用户名>
```

如果提示wheel组不存在, 则还需要先创建该组

```shell
groupadd wheel
```



##### 配置文件

sudo的权限控制可以在`/etc/sudoers`文件中查看到。一般来说，通过cat /etc/sudoers指令来查看该文件, 会看到如下几行代码。

```shell
[root@localhost ~]# egrep -v '^[ ]*$|^#' /etc/sudoers
=====省略=====
root    ALL=(ALL)     ALL
%wheel    ALL=(ALL)    ALL
```

对/etc/sudoers文件进行编辑的代码公式可以概括为

```shell
授权用户/组 主机=[(切换到哪些用户或组)] [是否需要输入密码验证] 命令1,命令2,...
字段1 字段2 =[(字段3)] [字段4] 字段5
```

凡是[ ]中的内容, 都能省略; 命令和命令之间用`,`号分隔，字段3、字段4，是可以省略的。

- "字段1"不以%号开头的表示"将要授权的用户"，以%号开头的表示"将要授权的组"。
- "字段2"表示允许登录的主机, ALL表示所有，;如果该字段不为ALL,表示授权用户只能在某些机器上登录本服务器来执行sudo命令
  - 比如:`jack mycomputer=/usr/sbin/reboot,/usr/sbin/shutdown`表示: 普通用户jack在主机(或主机组)mycomputer上, 可以通过sudo执行reboot和shutdown两个命令
- "字段3"如果省略, 相当于(root:root)，表示可以通过sudo提权到root，如果为(ALL)或者(ALL:ALL), 表示能够提权到(任意用户:任意用户组)。
- "字段4"的可能取值是NOPASSWD:。请注意NOPASSWD后面带有冒号:。表示执行sudo时可以不需要输入密码。
  - 比如:`lucy ALL=(ALL) NOPASSWD: /bin/useradd`表示: 普通用户lucy可以在任何主机上, 通过sudo执行/bin/useradd命令, 并且不需要输入密码
  - 比如:`peter ALL=(ALL) NOPASSWD: ALL`,表示: 普通用户peter可以在任何主机上, 通过sudo执行任何命令, 并且不需要输入密码。
- "字段5"是使用逗号分开一系列命令,这些命令就是授权给用户的操作; ALL表示允许所有操作。命令都是使用绝对路径, 这是为了避免目录下有同名命令被执行，从而造成安全隐患。
  - 如果你将授权写成如下安全性欠妥的格式:`lucy ALL=(ALL) chown,chmod,useradd`那么用户就有可能创建一个他自己的程序, 也命名为userad, 然后放在它的本地路径中, 如此一来他就能够使用root来执行这个"名为useradd的程序"。这是相当危险的!



##### 编辑配置文件

在实践中,去编辑`/etc/sudoers`文件，系统提示我没权限，这是因为`/etc/sudoers`的内容如此敏感，以至于该文件是只读的。所以，编辑该文件前，请确认清楚你知道自己正在做什么。

强烈建议通过`visudo`命令来修改该文件，通过`visudo`修改，如果配置出错，会有提示。

官方文档推荐的做法，不是直接修改`/etc/sudoers`文件，而是将修改写在`/etc/sudoers.d/`目录下的文件中。如果使用这种方式修改sudoers，需要在`/etc/sudoers`文件的最后行，加上`#includedir /etc/sudoers.d`一行(默认已有)。需要注意，这个`#includedir /etc/sudoers.d`中的`#`并不是注释，请勿修改。



### 六、sudo专项

#### 选项

- **-u**：以指定用户或 ID 运行命令(或编辑文件)
- **-l**：显示出自己（执行 sudo 的使用者）的权限
- **-b**：将要执行的指令放在后台执行
- **-i**： 以目标用户身份运行一个登录 shell；可同时指定一条命令。相当于切换到root，不过只需要用户自己的密码即可。



- 以管理员身份查看shadow文件

```shell
[root@localhost ~]# useradd user
[root@localhost ~]# su - user
[user@localhost ~]$ cat /etc/shadow
cat: /etc/shadow: 权限不够
[user@localhost ~]$ sudo -u root cat /etc/shadow
[sudo] user 的密码：
[user@localhost ~]$ sudo cat /etc/shadow
# sudo -u root用的比较多，可以被精简为sudo
```



免密操作：

```shell
user ALL=(root) NOPASSWD: /bin/chown,/usr/sbin/useradd
* 表示: 用户user能在所有可能出现的主机上, 提权到root下执行`/bin/chown`, 不必输入密码; 但运行`/usr/sbin/useradd`命令时需要密码
* 在具有sudo操作的用户下, 执行`sudo -l`可以查看到该用户被允许和被禁止运行的命令
```



禁止部分文件下的程序运行：

```shell
papi ALL=/usr/sbin/,/sbin/,!/usr/sbin/fdisk
* 命令前面加上!号表示取消该命令
* 用户papi在所有可能出现的主机上, 能够运行目录/usr/sbin和/sbin下所有的程序, 但fdisk除外。
```



- 默认情况下输入一次sudo可以保持15分钟不再要求输入密码，如果想要延长这个时间，可以修改配置文件

```shell
[root@localhost ~]# visudo
Defaults env_reset,pwfeedback,timestamp_timeout=60
# 这个是改成60分钟才会需要再次输入密码，并且输入密码的时候会显示*号
```



## 文件权限管理

- 第 0 位确定文件类型，第 1-3 位确定属主（该文件的所有者）拥有该文件的权限。
- 第4-6位确定属组（所有者的同组用户）拥有该文件的权限，第7-9位确定其他用户拥有该文件的权限。
- 其中，第 1、4、7 位表示读权限，如果用`r`字符表示，则有读权限，如果用`-`字符表示，则没有读权限；
- 第 2、5、8 位表示写权限，如果用`w`字符表示，则有写权限，如果用`-`字符表示没有写权限；第 3、6、9 位表示可执行权限，如果用`x`字符表示，则有执行权限，如果用`-`字符表示，则没有执行权限。



### 一、修改文件属主chown

chown用于设置文件所有者和文件关联组的命令

chown 需要超级用户`root`的权限才能执行此命令

```shell
chown [选项]... [所有者][:[组]] 文件...
```

选项

- **-R**: 处理指定目录以及其子目录下的所有文件
- **-v**: 显示详细的处理信息



### 二、修改文件权限chmod

chmod是控制用户对文件的权限的命令

```shell
chmod [选项]... 模式[,模式]... 文件...
```

#### 选项

- **-f**: 若该文件权限无法被更改也不要显示错误讯息
- **-v**: 显示权限变更的详细资料
- **-R**: 对目前目录下的所有文件与子目录进行相同的权限变更(即以递归的方式逐个变更)

#### 模式

mode : 权限设定字串，格式如下 :

```shell
[ugoa...][[+-=][rwx]...][,...]
```

- `u`表示该文件的拥有者，`g`表示与该文件的拥有者属于同一个群体(group)者，`o`表示其他以外的人，`a`表示这三者皆是。
- `+`表示增加权限、`-`表示取消权限、`=`表示唯一设定权限。
- `r`表示可读取，`w`表示可写入，`x`表示可执行
- `r-w-x`权限对文件和目录的意义

rwx对于文件和目录的不同作用：

| 权限      | 对文件的影响         | 对目录的影响                                         |
| :-------- | :------------------- | :--------------------------------------------------- |
| r         | 可以读取文件的内容   | 可以列出目录的内容(文件名)，同ls命令                 |
| w         | 可以更改文件的内容   | 可以创建或删除目录中的任一文件，同touch、rm命令      |
| x(可执行) | 可以作为命令执行文件 | 可以访问目录的内容(取决于目录中文件的权限)，同cd命令 |



#### 八进制语法

chmod命令可以使用八进制数来指定权限。将八进制数转化为二进制格式对应的数每一位分别对应着r\w\x。

如：

| 7    | 读 + 写 + 执行 | rwx  | 111  |
| ---- | -------------- | ---- | ---- |
| 5    | 读 + 执行      | r-x  | 101  |



### 三、文件访问控制列表

文件访问控制列表可以针对文件单独设置某个用户或者用户组队文件的管理权限。



#### getfacl命名

获取文件访问控制列表的详细内容

```shell
getfacl [-aceEsRLPtpndvh] file ...
```

选项

- **-a**：仅显示文件访问控制列表
- **-d**：仅显示默认的访问控制列表
- **-c**：不显示注释表头
- **-e**：显示所有的有效权限
- **-E**：显示无效权限
- **-R**：递归显示子目录
- **-t**：使用制表符分隔的输出格式



#### setfacl命令

用来设置更精确的文件权限

```shell
setfacl [-bkndRLP] { -m|-M|-x|-X ... } file ...
```

选项

- **-m**：更改文件的访问控制列表
- **-M**：从文件读取访问控制列表条目更改
- **-x**：根据文件中访问控制列表移除条目
- **-X**：从文件读取访问控制列表条目并删除
- **-b**：删除所有扩展访问控制列表条目
- **-k**：移除默认访问控制列表
- **-d**：应用到默认访问控制列表的操作
- **-R**：递归操作子目录



### 四、mask有效权限和umask

mask 权限，指的是用户或群组能拥有的最大 ACL 权限，也就是说，给用户或群组设定的 ACL 权限不能超过 mask 规定的权限范围，超出部分做无效处理。



umask命令指定在建立文件时预设的权限掩码，进程 新建文件、目录的默认权限会收到umask的影响，umask表示要减掉得到权限。

umask可用来设定[权限掩码]。[权限掩码]是由3个八进制的数字所组成，将现有的存取权限减掉权限掩码后，即可产生建立文件时预设的权限。

**用户的默认权限是777，文件的默认权限是666**

```shell
umask [选项][权限掩码]
```

选项

- **-S**：以文字的方式来表示权限掩码



### 五、特殊权限

文件除了上述的rwx权限以外，还有三个特殊权限：suid，sgid，sticky

#### suid

suid 属性只能运用在可执行文件上，含义是开放文件所有者的权限给其他用户，即当用户执行该执行文件时，会拥有该执行文件所有者的权限。如果给一个非二进制文件文件附加suid权限，则会显示大写S，属于无效。（开放属主的权限给其他用户）

#### sgid

sgid 属性可运用于文件或者目录，运用在文件的含义是开放文件所属组的权限给其他用户，即当用户执行该执行文件时，会拥有该执行文件所属组用户的权限。如果给一个非二进制文件文件附加sgid权限，则会显示大写S，属于无效。（对于目录，创建新文件时，文件属组统一为当前目录属组；对于可执行文件，发放属组的权限给其他用户）

#### sbit

sticky 权限只能运用于目录上，含义是该目录下所有的文件和子目录只能由所属者删除，即使其的权限是777或者其他。一个公共目录，每个人都可以创建文件，删除自己的文件，但不能删除别人的文件(仅对目录有效，限制目录中文件的删改)。



要设置特殊权限，可以使用`chmod`命令的4位数字表示法，其中第一位用于特殊权限，后三位分别代表所有者、组和其他用户的权限。特殊权限的设置如下：

\- `4`: 设置setuid。 - `2`: 设置setgid。 - `1`: 设置sticky bit。

以下是一些设置特殊权限的例子：

 设置setuid: `chmod u+s file` ;设置setgid: `chmod g+s file` ; 设置sticky bit: `chmod o+t /dir`



### 六、chattr文件属性

chattr命令用于改变文件属性。

这项指令可改变存放在文件或目录属性，这些属性共有以下8种模式：

- **a**：让文件或目录仅供追加用途
- **b**：不更新文件或目录的最后存取时间
- **c**：将文件或目录压缩后存放
- **i**：不得任意更动文件或目录
- **s**：保密性删除文件或目录
- **S**：即时更新文件或目录
- **u**：预防意外删除

```shell
chattr [-RV][+/-/=<属性>][文件或目录...]
```

选项

- **-R**：递归处理，将指定目录下的所有文件及子目录一并处理
- **-v <版本编号>**：设置文件或目录版本
- **-V**：显示指令执行过程
- **+ <属性>**：添加文件或目录的该项属性
- **- <属性>**：删除文件或目录的该项属性
- **= <属性>**：指定文件或目录的该项属性



## 各个命令的案例

查看ID

```shell
[root@localhost ~]# id
```

查看属主

```shell
[root@localhost ~]# ll anaconda-ks.cfg 
-rw-------. 1 root root 1241 4月   4 16:53 anaconda-ks.cfg
```

从“1”开始往右依次是文件硬盘连接数，文件属主，文件属组，文件大小，最后修改时间和文件名。

创建组并指定GID

```shell
[root@localhost ~]# groupadd hr -g 1000
[root@localhost ~]# groupadd sale -g 2000
[root@localhost ~]# tail -n 4 /etc/group
hr:x:1000:
sale:x:2000:
```

修改组名

```shell
[root@localhost ~]# groupmod -n finance fd
```

删除一个用户组

```shell
[root@localhost ~]# groupdel test
```

创建用户itadmin，并将其加入it组

```shell
[root@localhost ~]# useradd itadmin
[root@localhost ~]# gpasswd -a itadmin it
正在将用户“itadmin”加入到“it”组中
#cat /etc/group 和 #id itadmin 可分别查看组文件和用户信息里是否被修改
```

添加一般用户

```shell
[root@localhost ~]# useradd user01
```

为添加的用户指定相应的用户组

```shell
[root@localhost ~]# useradd -g root user02
```

为新添加的用户指定home目录

```shell
[root@localhost ~]# useradd -d /home/test user03
```

建立一个不给登录的用户

```shell
[root@localhost ~]# useradd -s /sbin/nologin user04
```

更改登录的目录

```shell
[root@localhost ~]# usermod -d /home user01
```

删除用户账号(普通删除)

```shell
 [root@localhost ~]# userdel user04
```

删除用户账户和家目录（删除用户登录目录及所有文件）

```shell
[root@localhost ~]# userdel -r user03
```

修改test01用户密码（只有root管理员才可以修改）

```shell
[root@localhost ~]# passwd test01
```

使用管道符设置用户密码

```shell
[root@localhost ~]# echo 123456 | passwd --stdin test01
```

强制用户在下次登录的时候换密码

```shell
[root@localhost ~]# chage -d 0 test01
```

以管理员身份查看shadow文件

```shell
[user@localhost ~]$ sudo -u root cat /etc/shadow
```

设置所有者为root

```shell
[root@localhost ~]# chown root anaconda-ks.cfg
```

将文件的拥有者设置为user01，允许使用的组设置为it

```shell
[root@localhost ~]# chown user01:it file.txt
```

将目录下的所有文件拥有者设置为user01，允许使用的组设置为it

```shell
[root@localhost ~]# chown -R user01:it dir/*
```

限制用户user1删除file/dir目录下的文件

```shell
[root@localhost ~]# chmod a-w /home/user1/file 
[root@localhost ~]# chmod a-w /home/user1/dir/
```

查看acl权限列表

```shell
[root@localhost ~]# getfacl anaconda-ks.cfg 
```

给指定用户添加acl权限

```shell
[root@localhost ~]# setfacl -m u:user1:rx /workdir/
```

移除user1的访问控制列表权限

```shell
[root@localhost ~]# setfacl -x u:user1 /workdir/
```

- 添加suid权限，可以输入下面两个命令

```shell
[root@localhost ~]#chmod u+s file
[root@localhost ~]#chmod 4765 file
```

- 设置sgid，让用户在workdir下创建的文件都属于worker组

```shell
[root@localhost /]# chmod g+s workdir/
[root@localhost /]# cd workdir/
[root@localhost workdir]# touch file
```

- 设置sticky，让普通用户只能创建文件，不能删除文件

```shell
[root@localhost ~]# chmod 777 /workdir/
[root@localhost ~]# chmod o+t /workdir/
[root@localhost ~]# su - user1
[user1@localhost ~]$ cd /workdir/
[user1@localhost workdir]$ touch user1file
[user1@localhost workdir]$ exit
登出
[root@localhost ~]# su - user2
[user2@localhost ~]$ cd /workdir/
[user2@localhost workdir]$ touch user2file
[user2@localhost workdir]$ rm -rf user1file   # 不给删除别人的文件
rm: 无法删除"user1file": 不允许的操作
[user2@localhost workdir]$ rm -rf user2file   # 只能删除自己的文件
```

- 用chattr命令防止系统中某个关键文件被修改

```shell
[root@localhost ~]# chattr +i /etc/resolv.conf
[root@localhost ~]# lsattr /etc/resolv.conf 
----i----------- /etc/resolv.conf
[root@localhost ~]# echo test >> /etc/resolv.conf
-bash: /etc/resolv.conf: 权限不够
```

- 让某个文件只能往里面追加数据，但不能删除，适用于各种日志文件

```shell
[root@localhost ~]# chattr +a /var/log/messages 
[root@localhost ~]# lsattr /var/log/messages 
-----a---------- /var/log/messages
[root@localhost ~]# echo > /var/log/messages   # 不允许清空日志
-bash: /var/log/messages: 不允许的操作
```

- 查看当前用户的umask权限

```shell
[root@localhost ~]# umask
0022
```

- 查看最终有的权限

```shell
[root@localhost ~]# umask -S
u=rwx,g=rx,o=rx
```

- 修改umask的数值(临时)

```shell
[root@localhost ~]# umask 0000
[root@localhost ~]# mkdir dir
[root@localhost ~]# ll
总用量 4
drwxrwxrwx. 2 root root    6 4月  14 11:25 dir
-rw-rw-rw-. 1 root root    0 4月  14 11:25 file
```

- 修改umask的数值(永久)

```shell
[root@localhost ~]# vim /etc/profile
--------------
 59 if [ $UID -gt 199 ] && [ "`/usr/bin/id -gn`" = "`/usr/bin/id -un`" ]; then
 60     umask 002
 61 else
 62     umask 022
 63 fi
---------------
[root@localhost ~]# source /etc/profile        # 立即在当前shell中生效
```

- 通过umask决定新建用户`HOME`目录的权限

```shell
[root@localhost ~]# vim /etc/login.defs 
-----------------
 61 # The permission mask is initialized to this value. If not specified, 
 62 # the permission mask will be initialized to 022.
 63 UMASK           077
------------------
```



# 重点

用户/用户组管理

groupadd -g

groupmod

groupdel

gpasswd

useradd

usermod

userdel

相关文件：passwd,shadow,group

相关命令：passwd,chage

